<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 807e28ca-9ee4-4546-b945-c7d6dad74002 (2025-12-09 05:52Z) -->

# Incorrect PDF file generated (2025-12-09 05:52Z)

_**User (2025-12-09 05:52Z)**_

the generate pdf ends up generating this file i've attached 

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user is saying that when they generate a PDF, it produces a file they've attached. However, I don't see any attached file in the message. Let me check if there's an image or file that was supposed to be attached.

Looking at the message, I don't see any attachment. I should ask the user to share the file or describe what's wrong with the generated PDF. But first, let me explore the codebase to understand the PDF generation functionality so I can better assist when they provide more details.

Let me look at the codebase structure and find the PDF generation code.</details></think>

---

I don't see an attached file in your message. Could you please attach the PDF or a screenshot showing what the generated PDF looks like? 

In the meantime, let me look at the PDF generation code in your project to understand the current implementation.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** ‚Ä¢ Searched codebase "How does the PDF generation work for recipes?" ‚Ä¢ **11** results</summary>
            
| File | Lines |
|------|-------|
| `app/components/RecipeDisplay.tsx` | L38-374 |
| `app/components/RecipeDisplay.tsx` | L38 |
| `app/api/generate-recipe/route.ts` | L17-114 |
| `app/components/RecipeDisplay.tsx` | L34-374 |
| `app/api/generate-recipe/route.ts` | L25 |
| `app/page.tsx` | L68-485 |
| `app/api/generate-recipe/route.ts` | L25-114 |
| `initial-spec.md` | L46 |
| `initial-spec.md` | L388-463 |
| `initial-spec.md` | L39-96 |
| `app/api/analyze/route.ts` | L71 |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory undefined ‚Ä¢ **0** results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I see the PDF generation code uses `jsPDF` and `html2canvas`. Let me read the full RecipeDisplay.tsx file to understand exactly how the PDF is generated, since the search result was truncated. There seem to be some syntax issues in the displayed code (like line 38 missing a closing brace, line 46-54 have incomplete code).

The user mentioned they've attached a file showing the generated PDF output but I don't see any attachment. I should ask them to share what the issue is, but first let me read the full file.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: app/components/RecipeDisplay.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I now have the full RecipeDisplay.tsx code. The PDF generation uses html2canvas to capture the recipe content as an image, then adds it to a jsPDF document.

The user said they've attached a file showing what the generated PDF looks like, but I don't actually see any attachment. I should ask them to share the file or describe what the issue is with the generated PDF.

Common issues with this approach could be:
1. CSS not rendering properly in html2canvas
2. Custom fonts not being captured
3. Images not loading due to CORS
4. Multi-page slicing causing content to be cut off
5. Background colors or gradients not rendering
6. CSS variables not being resolved

I should ask the user to share what they're seeing in the PDF so I can help fix the issue.</details></think>

---

I can see the PDF generation code in `RecipeDisplay.tsx`. It uses `html2canvas` to capture the recipe as an image and then adds it to a `jsPDF` document.

However, I don't see an attached file in your message. Could you please:
1. Attach the PDF file or a screenshot of what it looks like, OR
2. Describe what's wrong with the generated PDF (e.g., blank pages, missing content, styling issues, cut-off text, etc.)

This will help me understand what specific issue needs to be fixed.

---

_**User (2025-12-09 05:52Z)**_



---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
Now I can see the issue! The generated PDF has severely distorted/corrupted text rendering. The text appears garbled, stretched, and overlapping. This is a common issue with html2canvas when:

1. Custom fonts aren't loaded properly before canvas capture
2. CSS variables aren't being resolved
3. The scale factor causes issues with text rendering
4. Font rendering issues with html2canvas

The text is completely unreadable - it looks like the characters are being stretched and duplicated horizontally. This is typically a font rendering issue with html2canvas.

The fix would be to:
1. Ensure fonts are fully loaded before capturing
2. Use a different approach - perhaps generating a proper PDF with jsPDF's text methods instead of relying on html2canvas
3. Or use a CSS print stylesheet and let the browser handle PDF generation

Let me create a proper PDF generation that doesn't rely on html2canvas for text, or fix the html2canvas configuration.

The best approach would be to generate the PDF using jsPDF's native text rendering capabilities instead of converting HTML to canvas. This will ensure clean, readable text.</details></think>

---

I see the problem! The PDF has severely corrupted/garbled text rendering. This is a known issue with `html2canvas` - it struggles with custom fonts, CSS variables, and certain text rendering scenarios.

**Plan:** Replace the html2canvas approach with native jsPDF text rendering, which produces clean, readable PDFs.

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: app/components/RecipeDisplay.tsx</summary>

**Chunk 1**
Lines added: 390, lines removed: 320

```diff
@@ -55,323 +55,393 @@
  
    const handleDownloadPDF = async () =&gt; {
-     if (!recipeRef.current) return;
+     setIsDownloading(true);
...
-     setIsDownloading(true);
-     
-     // Store original image src to restore later
-     const imgElement = recipeRef.current.querySelector('img') as HTMLImageElement | null;
-     const originalSrc = imgElement?.src;
-     
-     try {
-       // Convert external image to base64 via proxy to avoid CORS issues
-       if (imgElement &amp;&amp; recipe.imageUrl) {
-         try {
-           const proxyResponse = await fetch(&#96;/api/proxy-image?url=${encodeURIComponent(recipe.imageUrl)}&#96;);
-           if (proxyResponse.ok) {
-             const { dataUrl } = await proxyResponse.json();
-             imgElement.src = dataUrl;
-             // Wait for image to load with new src
-             await new Promise((resolve) =&gt; {
-               imgElement.onload = resolve;
-               setTimeout(resolve, 100); // Fallback timeout
-             });
-           }
-         } catch (proxyError) {
-           console.warn('Could not proxy image, PDF may not include the image:', proxyError);
-         }
-       }
-       
-       const canvas = await html2canvas(recipeRef.current, {
-         scale: 2,
-         useCORS: true,
-         allowTaint: true,
-         backgroundColor: '#FFFBF5',
-         logging: false,
-       });
-       
-       const imgData = canvas.toDataURL('image/png');
-       const pdf = new jsPDF({
-         orientation: 'portrait',
-         unit: 'mm',
-         format: 'a4',
-       });
-       
-       const pdfWidth = pdf.internal.pageSize.getWidth();
-       const pdfHeight = pdf.internal.pageSize.getHeight();
-       const imgWidth = canvas.width;
-       const imgHeight = canvas.height;
-       const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
-       
-       // Calculate total height needed
-       const scaledImgHeight = imgHeight * ratio * (pdfWidth / imgWidth) * 0.95;
-       const pageContentHeight = pdfHeight - 20; // margins
-       
-       if (scaledImgHeight &lt;= pageContentHeight) {
-         // Single page
-         pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, scaledImgHeight);
-       } else {
-         // Multi-page
-         let remainingHeight = imgHeight;
-         let sourceY = 0;
-         const sourcePageHeight = (pageContentHeight / (pdfWidth - 20)) * imgWidth;
-         
-         while (remainingHeight &gt; 0) {
-           const sliceHeight = Math.min(sourcePageHeight, remainingHeight);
-           
-           // Create a temporary canvas for this page slice
-           const pageCanvas = document.createElement('canvas');
-           pageCanvas.width = imgWidth;
-           pageCanvas.height = sliceHeight;
-           const ctx = pageCanvas.getContext('2d');
-           
-           if (ctx) {
-             ctx.drawImage(
-               canvas,
-               0, sourceY, imgWidth, sliceHeight,
-               0, 0, imgWidth, sliceHeight
-             );
-             
-             const pageImgData = pageCanvas.toDataURL('image/png');
-             const destHeight = (sliceHeight / imgWidth) * (pdfWidth - 20);
-             pdf.addImage(pageImgData, 'PNG', 10, 10, pdfWidth - 20, destHeight);
-           }
-           
-           remainingHeight -= sliceHeight;
-           sourceY += sliceHeight;
-           
-           if (remainingHeight &gt; 0) {
-             pdf.addPage();
-           }
-         }
-       }
-       
-       // Generate filename from recipe title
-       const filename = &#96;${recipe.title.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-recipe.pdf&#96;;
-       pdf.save(filename);
-     } catch (error) {
-       console.error('Error generating PDF:', error);
-     } finally {
-       // Restore original image src
-       if (imgElement &amp;&amp; originalSrc) {
-         imgElement.src = originalSrc;
-       }
-       setIsDownloading(false);
-     }
-   };
- 
-   return (
-     &lt;div className="max-w-2xl mx-auto"&gt;
-       &lt;div ref={recipeRef}&gt;
-       {/* Recipe Header */}
-       {recipe.imageUrl &amp;&amp; (
-         &lt;div className="relative h-64 mb-6 rounded-xl overflow-hidden"&gt;
-           &lt;img
-             src={recipe.imageUrl}
-             alt={recipe.title}
-             className="w-full h-full object-cover"
-           /&gt;
-           &lt;div 
-             className="absolute inset-0"
-             style={{ background: 'linear-gradient(to top, rgba(61,35,20,0.8) 0%, transparent 50%)' }}
-           /&gt;
-           &lt;h1 
-             className="absolute bottom-4 left-4 right-4 text-white text-2xl font-bold"
-             style={{ fontFamily: 'var(--font-fraunces), var(--font-serif)' }}
-           &gt;
-             {recipe.title}
-           &lt;/h1&gt;
-         &lt;/div&gt;
-       )}
- 
-       {!recipe.imageUrl &amp;&amp; (
-         &lt;div 
-           className="rounded-xl p-6 mb-6"
-           style={{ background: 'linear-gradient(135deg, #E85D04 0%, #F9DC5C 100%)' }}
-         &gt;
-           &lt;h1 
-             className="text-white text-2xl font-bold"
-             style={{ fontFamily: 'var(--font-fraunces), var(--font-serif)' }}
-           &gt;
-             {recipe.title}
-           &lt;/h1&gt;
-         &lt;/div&gt;
-       )}
- 
-       {/* Quick Stats */}
-       &lt;div className="card p-4 mb-6"&gt;
-         &lt;div className="grid grid-cols-4 gap-2 text-center"&gt;
-           &lt;div&gt;
-             &lt;span className="text-xl"&gt;üî™&lt;/span&gt;
-             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.prepTime}&lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Prep&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;span className="text-xl"&gt;üî•&lt;/span&gt;
-             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.cookTime}&lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Cook&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;span className="text-xl"&gt;üçΩÔ∏è&lt;/span&gt;
-             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.servings}&lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Serves&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;span className="text-xl"&gt;üìä&lt;/span&gt;
-             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.difficulty}&lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Level&lt;/p&gt;
-           &lt;/div&gt;
-         &lt;/div&gt;
-       &lt;/div&gt;
- 
-       {/* Tags */}
-       &lt;div className="flex flex-wrap gap-2 mb-6"&gt;
-         {recipe.tags.map((tag) =&gt; (
-           &lt;span 
-             key={tag}
-             className="tag text-sm"
-           &gt;
-             {tag}
-           &lt;/span&gt;
-         ))}
-       &lt;/div&gt;
- 
-       {/* Description */}
-       &lt;p 
-         className="mb-6 leading-relaxed"
-         style={{ color: 'var(--color-text-secondary)' }}
-       &gt;
-         {recipe.description}
-       &lt;/p&gt;
- 
-       {/* Ingredients */}
-       &lt;div className="card p-5 mb-6"&gt;
-         &lt;h2 
-           className="text-lg font-bold mb-4"
-           style={{ color: 'var(--color-text)' }}
-         &gt;
-           Ingredients
-         &lt;/h2&gt;
-         &lt;div className="space-y-3"&gt;
-           {recipe.ingredients.map((ingredient, index) =&gt; (
-             &lt;label
-               key={index}
-               className="flex items-start gap-3 cursor-pointer"
-             &gt;
-               &lt;input
-                 type="checkbox"
-                 checked={checkedIngredients.has(index)}
-                 onChange={() =&gt; toggleIngredient(index)}
-                 className="mt-1 w-5 h-5 rounded border-2 accent-orange-500"
-                 style={{ accentColor: 'var(--color-primary)' }}
-               /&gt;
-               &lt;span className={checkedIngredients.has(index) ? 'line-through opacity-50' : ''}&gt;
-                 &lt;strong style={{ color: 'var(--color-text)' }}&gt;{ingredient.amount}&lt;/strong&gt;{' '}
-                 &lt;span style={{ color: 'var(--color-text)' }}&gt;{ingredient.item}&lt;/span&gt;
-                 {ingredient.preparation &amp;&amp; (
-                   &lt;span style={{ color: 'var(--color-primary)' }}&gt;, {ingredient.preparation}&lt;/span&gt;
-                 )}
-               &lt;/span&gt;
-             &lt;/label&gt;
-           ))}
-         &lt;/div&gt;
-       &lt;/div&gt;
- 
-       {/* Instructions */}
-       &lt;div className="card p-5 mb-6"&gt;
-         &lt;h2 
-           className="text-lg font-bold mb-4"
-           style={{ color: 'var(--color-text)' }}
-         &gt;
-           Instructions
-         &lt;/h2&gt;
-         &lt;div className="space-y-6"&gt;
-           {recipe.instructions.map((instruction) =&gt; (
-             &lt;div key={instruction.step} className="flex gap-4"&gt;
-               &lt;div 
-                 className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
-                 style={{ backgroundColor: 'var(--color-primary)' }}
-               &gt;
-                 {instruction.step}
-               &lt;/div&gt;
-               &lt;div className="flex-1"&gt;
-                 &lt;p style={{ color: 'var(--color-text)' }}&gt;{instruction.text}&lt;/p&gt;
-                 {instruction.tip &amp;&amp; (
-                   &lt;div 
-                     className="mt-2 p-3 rounded-lg text-sm flex items-start gap-2"
-                     style={{ backgroundColor: 'var(--color-amber-mist)' }}
-                   &gt;
-                     &lt;span&gt;üí°&lt;/span&gt;
-                     &lt;span style={{ color: 'var(--color-text-secondary)' }}&gt;{instruction.tip}&lt;/span&gt;
-                   &lt;/div&gt;
-                 )}
-               &lt;/div&gt;
-             &lt;/div&gt;
-           ))}
-         &lt;/div&gt;
-       &lt;/div&gt;
- 
-       {/* Nutrition */}
-       &lt;div className="card p-5 mb-6"&gt;
-         &lt;h2 
-           className="text-lg font-bold mb-4"
-           style={{ color: 'var(--color-text)' }}
-         &gt;
-           Estimated Nutrition &lt;span className="font-normal text-sm" style={{ color: 'var(--color-text-secondary)' }}&gt;(per serving)&lt;/span&gt;
-         &lt;/h2&gt;
-         &lt;div className="grid grid-cols-4 gap-4 text-center"&gt;
-           &lt;div&gt;
-             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
-               {recipe.nutritionEstimate.calories.replace('~', '').replace(' per serving', '')}
-             &lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Calories&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
-               {recipe.nutritionEstimate.protein}
-             &lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Protein&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
-               {recipe.nutritionEstimate.carbs}
-             &lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Carbs&lt;/p&gt;
-           &lt;/div&gt;
-           &lt;div&gt;
-             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
-               {recipe.nutritionEstimate.fat}
-             &lt;/p&gt;
-             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Fat&lt;/p&gt;
-           &lt;/div&gt;
-         &lt;/div&gt;
-       &lt;/div&gt;
- 
-       &lt;/div&gt;
- 
-       {/* Action Buttons */}
-       &lt;div className="flex gap-4 no-print"&gt;
-         &lt;button
-           onClick={handleDownloadPDF}
-           disabled={isDownloading}
-           className="btn btn-secondary flex-1"
-         &gt;
-           {isDownloading ? '‚è≥ Generating...' : 'üì• Download PDF'}
-         &lt;/button&gt;
-         &lt;button
-           onClick={onRegenerate}
-           className="btn btn-secondary flex-1"
-         &gt;
-           üîÑ Regenerate
-         &lt;/button&gt;
-         &lt;button
-           onClick={onStartOver}
-           className="btn btn-primary flex-1"
-         &gt;
-           ‚Ü∫ Start Over
-         &lt;/button&gt;
-       &lt;/div&gt;
-     &lt;/div&gt;
-   );
- }
- 
- 
+     try {
+       const pdf = new jsPDF({
+         orientation: 'portrait',
+         unit: 'mm',
+         format: 'a4',
+       });
+       
+       const pageWidth = pdf.internal.pageSize.getWidth();
+       const pageHeight = pdf.internal.pageSize.getHeight();
+       const margin = 15;
+       const contentWidth = pageWidth - margin * 2;
+       let y = margin;
+       
+       const colors = {
+         primary: [232, 93, 4] as [number, number, number],      // #E85D04
+         text: [61, 35, 20] as [number, number, number],         // #3D2314
+         textSecondary: [139, 90, 43] as [number, number, number], // #8B5A2B
+         background: [255, 251, 245] as [number, number, number], // #FFFBF5
+         cardBg: [255, 255, 255] as [number, number, number],
+         amber: [254, 243, 199] as [number, number, number],     // amber-100
+       };
+       
+       // Helper to check and add new page
+       const checkNewPage = (neededHeight: number) =&gt; {
+         if (y + neededHeight &gt; pageHeight - margin) {
+           pdf.addPage();
+           y = margin;
+           return true;
+         }
+         return false;
+       };
+       
+       // Helper for wrapped text
+       const addWrappedText = (text: string, x: number, maxWidth: number, lineHeight: number) =&gt; {
+         const lines = pdf.splitTextToSize(text, maxWidth);
+         for (const line of lines) {
+           checkNewPage(lineHeight);
+           pdf.text(line, x, y);
+           y += lineHeight;
+         }
+       };
+       
+       // Add recipe image if available
+       if (recipe.imageUrl) {
+         try {
+           const proxyResponse = await fetch(&#96;/api/proxy-image?url=${encodeURIComponent(recipe.imageUrl)}&#96;);
+           if (proxyResponse.ok) {
+             const { dataUrl } = await proxyResponse.json();
+             const imgHeight = 50;
+             pdf.addImage(dataUrl, 'JPEG', margin, y, contentWidth, imgHeight);
+             y += imgHeight + 5;
+           }
+         } catch {
+           // Skip image if proxy fails
+         }
+       }
+       
+       // Title
+       pdf.setFontSize(24);
+       pdf.setFont('helvetica', 'bold');
+       pdf.setTextColor(...colors.primary);
+       const titleLines = pdf.splitTextToSize(recipe.title, contentWidth);
+       for (const line of titleLines) {
+         pdf.text(line, margin, y);
+         y += 10;
+       }
+       y += 3;
+       
+       // Quick stats bar
+       pdf.setFontSize(10);
+       pdf.setFont('helvetica', 'normal');
+       pdf.setTextColor(...colors.textSecondary);
+       const stats = &#96;üî™ ${recipe.prepTime} Prep  ‚Ä¢  üî• ${recipe.cookTime} Cook  ‚Ä¢  üçΩÔ∏è ${recipe.servings} Servings  ‚Ä¢  üìä ${recipe.difficulty}&#96;;
+       pdf.text(stats, margin, y);
+       y += 8;
+       
+       // Tags
+       if (recipe.tags.length &gt; 0) {
+         pdf.setFontSize(9);
+         pdf.setTextColor(...colors.primary);
+         pdf.text(recipe.tags.join('  ‚Ä¢  '), margin, y);
+         y += 8;
+       }
+       
+       // Description
+       pdf.setFontSize(11);
+       pdf.setFont('helvetica', 'normal');
+       pdf.setTextColor(...colors.textSecondary);
+       addWrappedText(recipe.description, margin, contentWidth, 5);
+       y += 5;
+       
+       // Ingredients section
+       checkNewPage(20);
+       pdf.setFontSize(14);
+       pdf.setFont('helvetica', 'bold');
+       pdf.setTextColor(...colors.text);
+       pdf.text('Ingredients', margin, y);
+       y += 8;
+       
+       pdf.setFontSize(10);
+       pdf.setFont('helvetica', 'normal');
+       for (const ingredient of recipe.ingredients) {
+         checkNewPage(6);
+         pdf.setTextColor(...colors.text);
+         const ingredientText = &#96;‚Ä¢ ${ingredient.amount} ${ingredient.item}${ingredient.preparation ? &#96;, ${ingredient.preparation}&#96; : ''}&#96;;
+         const ingredientLines = pdf.splitTextToSize(ingredientText, contentWidth);
+         for (const line of ingredientLines) {
+           pdf.text(line, margin, y);
+           y += 5;
+         }
+       }
+       y += 5;
+       
+       // Instructions section
+       checkNewPage(20);
+       pdf.setFontSize(14);
+       pdf.setFont('helvetica', 'bold');
+       pdf.setTextColor(...colors.text);
+       pdf.text('Instructions', margin, y);
+       y += 8;
+       
+       pdf.setFontSize(10);
+       for (const instruction of recipe.instructions) {
+         checkNewPage(15);
+         
+         // Step number
+         pdf.setFont('helvetica', 'bold');
+         pdf.setTextColor(...colors.primary);
+         pdf.text(&#96;Step ${instruction.step}&#96;, margin, y);
+         y += 5;
+         
+         // Instruction text
+         pdf.setFont('helvetica', 'normal');
+         pdf.setTextColor(...colors.text);
+         addWrappedText(instruction.text, margin, contentWidth, 5);
+         
+         // Tip if present
+         if (instruction.tip) {
+           checkNewPage(10);
+           pdf.setTextColor(...colors.textSecondary);
+           pdf.setFontSize(9);
+           addWrappedText(&#96;üí° Tip: ${instruction.tip}&#96;, margin + 5, contentWidth - 5, 4);
+           pdf.setFontSize(10);
+         }
+         y += 3;
+       }
+       y += 5;
+       
+       // Nutrition section
+       checkNewPage(25);
+       pdf.setFontSize(14);
+       pdf.setFont('helvetica', 'bold');
+       pdf.setTextColor(...colors.text);
+       pdf.text('Estimated Nutrition (per serving)', margin, y);
+       y += 8;
+       
+       pdf.setFontSize(10);
+       pdf.setFont('helvetica', 'normal');
+       const nutrition = recipe.nutritionEstimate;
+       const nutritionText = &#96;Calories: ${nutrition.calories}  ‚Ä¢  Protein: ${nutrition.protein}  ‚Ä¢  Carbs: ${nutrition.carbs}  ‚Ä¢  Fat: ${nutrition.fat}&#96;;
+       pdf.setTextColor(...colors.primary);
+       pdf.text(nutritionText, margin, y);
+       
+       // Generate filename and save
+       const filename = &#96;${recipe.title.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-recipe.pdf&#96;;
+       pdf.save(filename);
+     } catch (error) {
+       console.error('Error generating PDF:', error);
+     } finally {
+       setIsDownloading(false);
+     }
+   };
+ 
+   return (
+     &lt;div className="max-w-2xl mx-auto"&gt;
+       &lt;div ref={recipeRef}&gt;
+       {/* Recipe Header */}
+       {recipe.imageUrl &amp;&amp; (
+         &lt;div className="relative h-64 mb-6 rounded-xl overflow-hidden"&gt;
+           &lt;img
+             src={recipe.imageUrl}
+             alt={recipe.title}
+             className="w-full h-full object-cover"
+           /&gt;
+           &lt;div 
+             className="absolute inset-0"
+             style={{ background: 'linear-gradient(to top, rgba(61,35,20,0.8) 0%, transparent 50%)' }}
+           /&gt;
+           &lt;h1 
+             className="absolute bottom-4 left-4 right-4 text-white text-2xl font-bold"
+             style={{ fontFamily: 'var(--font-fraunces), var(--font-serif)' }}
+           &gt;
+             {recipe.title}
+           &lt;/h1&gt;
+         &lt;/div&gt;
+       )}
+ 
+       {!recipe.imageUrl &amp;&amp; (
+         &lt;div 
+           className="rounded-xl p-6 mb-6"
+           style={{ background: 'linear-gradient(135deg, #E85D04 0%, #F9DC5C 100%)' }}
+         &gt;
+           &lt;h1 
+             className="text-white text-2xl font-bold"
+             style={{ fontFamily: 'var(--font-fraunces), var(--font-serif)' }}
+           &gt;
+             {recipe.title}
+           &lt;/h1&gt;
+         &lt;/div&gt;
+       )}
+ 
+       {/* Quick Stats */}
+       &lt;div className="card p-4 mb-6"&gt;
+         &lt;div className="grid grid-cols-4 gap-2 text-center"&gt;
+           &lt;div&gt;
+             &lt;span className="text-xl"&gt;üî™&lt;/span&gt;
+             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.prepTime}&lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Prep&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;span className="text-xl"&gt;üî•&lt;/span&gt;
+             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.cookTime}&lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Cook&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;span className="text-xl"&gt;üçΩÔ∏è&lt;/span&gt;
+             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.servings}&lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Serves&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;span className="text-xl"&gt;üìä&lt;/span&gt;
+             &lt;p className="font-bold" style={{ color: 'var(--color-text)' }}&gt;{recipe.difficulty}&lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Level&lt;/p&gt;
+           &lt;/div&gt;
+         &lt;/div&gt;
+       &lt;/div&gt;
+ 
+       {/* Tags */}
+       &lt;div className="flex flex-wrap gap-2 mb-6"&gt;
+         {recipe.tags.map((tag) =&gt; (
+           &lt;span 
+             key={tag}
+             className="tag text-sm"
+           &gt;
+             {tag}
+           &lt;/span&gt;
+         ))}
+       &lt;/div&gt;
+ 
+       {/* Description */}
+       &lt;p 
+         className="mb-6 leading-relaxed"
+         style={{ color: 'var(--color-text-secondary)' }}
+       &gt;
+         {recipe.description}
+       &lt;/p&gt;
+ 
+       {/* Ingredients */}
+       &lt;div className="card p-5 mb-6"&gt;
+         &lt;h2 
+           className="text-lg font-bold mb-4"
+           style={{ color: 'var(--color-text)' }}
+         &gt;
+           Ingredients
+         &lt;/h2&gt;
+         &lt;div className="space-y-3"&gt;
+           {recipe.ingredients.map((ingredient, index) =&gt; (
+             &lt;label
+               key={index}
+               className="flex items-start gap-3 cursor-pointer"
+             &gt;
+               &lt;input
+                 type="checkbox"
+                 checked={checkedIngredients.has(index)}
+                 onChange={() =&gt; toggleIngredient(index)}
+                 className="mt-1 w-5 h-5 rounded border-2 accent-orange-500"
+                 style={{ accentColor: 'var(--color-primary)' }}
+               /&gt;
+               &lt;span className={checkedIngredients.has(index) ? 'line-through opacity-50' : ''}&gt;
+                 &lt;strong style={{ color: 'var(--color-text)' }}&gt;{ingredient.amount}&lt;/strong&gt;{' '}
+                 &lt;span style={{ color: 'var(--color-text)' }}&gt;{ingredient.item}&lt;/span&gt;
+                 {ingredient.preparation &amp;&amp; (
+                   &lt;span style={{ color: 'var(--color-primary)' }}&gt;, {ingredient.preparation}&lt;/span&gt;
+                 )}
+               &lt;/span&gt;
+             &lt;/label&gt;
+           ))}
+         &lt;/div&gt;
+       &lt;/div&gt;
+ 
+       {/* Instructions */}
+       &lt;div className="card p-5 mb-6"&gt;
+         &lt;h2 
+           className="text-lg font-bold mb-4"
+           style={{ color: 'var(--color-text)' }}
+         &gt;
+           Instructions
+         &lt;/h2&gt;
+         &lt;div className="space-y-6"&gt;
+           {recipe.instructions.map((instruction) =&gt; (
+             &lt;div key={instruction.step} className="flex gap-4"&gt;
+               &lt;div 
+                 className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
+                 style={{ backgroundColor: 'var(--color-primary)' }}
+               &gt;
+                 {instruction.step}
+               &lt;/div&gt;
+               &lt;div className="flex-1"&gt;
+                 &lt;p style={{ color: 'var(--color-text)' }}&gt;{instruction.text}&lt;/p&gt;
+                 {instruction.tip &amp;&amp; (
+                   &lt;div 
+                     className="mt-2 p-3 rounded-lg text-sm flex items-start gap-2"
+                     style={{ backgroundColor: 'var(--color-amber-mist)' }}
+                   &gt;
+                     &lt;span&gt;üí°&lt;/span&gt;
+                     &lt;span style={{ color: 'var(--color-text-secondary)' }}&gt;{instruction.tip}&lt;/span&gt;
+                   &lt;/div&gt;
+                 )}
+               &lt;/div&gt;
+             &lt;/div&gt;
+           ))}
+         &lt;/div&gt;
+       &lt;/div&gt;
+ 
+       {/* Nutrition */}
+       &lt;div className="card p-5 mb-6"&gt;
+         &lt;h2 
+           className="text-lg font-bold mb-4"
+           style={{ color: 'var(--color-text)' }}
+         &gt;
+           Estimated Nutrition &lt;span className="font-normal text-sm" style={{ color: 'var(--color-text-secondary)' }}&gt;(per serving)&lt;/span&gt;
+         &lt;/h2&gt;
+         &lt;div className="grid grid-cols-4 gap-4 text-center"&gt;
+           &lt;div&gt;
+             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
+               {recipe.nutritionEstimate.calories.replace('~', '').replace(' per serving', '')}
+             &lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Calories&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
+               {recipe.nutritionEstimate.protein}
+             &lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Protein&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
+               {recipe.nutritionEstimate.carbs}
+             &lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Carbs&lt;/p&gt;
+           &lt;/div&gt;
+           &lt;div&gt;
+             &lt;p className="text-xl font-bold" style={{ color: 'var(--color-primary)' }}&gt;
+               {recipe.nutritionEstimate.fat}
+             &lt;/p&gt;
+             &lt;p className="text-xs" style={{ color: 'var(--color-text-secondary)' }}&gt;Fat&lt;/p&gt;
+           &lt;/div&gt;
+         &lt;/div&gt;
+       &lt;/div&gt;
+ 
+       &lt;/div&gt;
+ 
+       {/* Action Buttons */}
+       &lt;div className="flex gap-4 no-print"&gt;
+         &lt;button
+           onClick={handleDownloadPDF}
+           disabled={isDownloading}
+           className="btn btn-secondary flex-1"
+         &gt;
+           {isDownloading ? '‚è≥ Generating...' : 'üì• Download PDF'}
+         &lt;/button&gt;
+         &lt;button
+           onClick={onRegenerate}
+           className="btn btn-secondary flex-1"
+         &gt;
+           üîÑ Regenerate
+         &lt;/button&gt;
+         &lt;button
+           onClick={onStartOver}
+           className="btn btn-primary flex-1"
+         &gt;
+           ‚Ü∫ Start Over
+         &lt;/button&gt;
+       &lt;/div&gt;
+     &lt;/div&gt;
+   );
+ }
+ 
+ 
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me also remove the unused html2canvas import since we're no longer using it:</details></think>

---

Now let me remove the unused `html2canvas` import:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: app/components/RecipeDisplay.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -3,5 +3,4 @@
  import { useState, useRef } from 'react';
  import jsPDF from 'jspdf';
- import html2canvas from 'html2canvas';
  
  export interface RecipeData {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me also remove the `recipeRef` since we're no longer using it for capturing, and update the JSX to remove the ref. Actually, let me check the lints first to see if there are any errors.</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** ‚Ä¢ Read lints for 1 file</summary>
      
Lint paths:

- `app/components/RecipeDisplay.tsx`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Good, no linter errors. But let me clean up the unused `recipeRef` since we no longer need it:</details></think>

---

Let me also clean up the unused `recipeRef` since we no longer use html2canvas:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: app/components/RecipeDisplay.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -1,5 +1,5 @@
  'use client';
  
- import { useState, useRef } from 'react';
+ import { useState } from 'react';
  import jsPDF from 'jspdf';
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: app/components/RecipeDisplay.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -41,5 +41,4 @@
    const [checkedIngredients, setCheckedIngredients] = useState&lt;Set&lt;number&gt;&gt;(new Set());
    const [isDownloading, setIsDownloading] = useState(false);
-   const recipeRef = useRef&lt;HTMLDivElement&gt;(null);
  
    const toggleIngredient = (index: number) =&gt; {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me also remove the ref from the JSX div:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: app/components/RecipeDisplay.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -230,5 +230,5 @@
    return (
      &lt;div className="max-w-2xl mx-auto"&gt;
-       &lt;div ref={recipeRef}&gt;
+       &lt;div&gt;
        {/* Recipe Header */}
        {recipe.imageUrl &amp;&amp; (
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me check the lints again to make sure everything is good:</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** ‚Ä¢ Read lints for 1 file</summary>
      
Lint paths:

- `app/components/RecipeDisplay.tsx`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Good, no linter errors. Let me also check the terminals to see if the dev server is running, and then test the PDF generation in the browser.</details></think>

---

Done! I've completely replaced the PDF generation approach.

**What changed:**
1. Removed `html2canvas` - this was causing the garbled text rendering
2. Now using jsPDF's native text rendering methods which produce clean, crisp text
3. Removed unused `useRef` and the `recipeRef` 

**The new PDF includes:**
- Recipe image (if available, via proxy)
- Title in orange/primary color
- Quick stats bar (prep time, cook time, servings, difficulty)
- Tags
- Description
- Ingredients list with bullet points
- Numbered instructions with tips
- Nutrition information
- Automatic page breaks when content overflows

The PDF will now render with proper, readable text using Helvetica (a standard PDF font). Try generating a PDF again - the text should be clear and legible now.

---

